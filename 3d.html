<!DOCTYPE html>
<html>
    <haed>
        <title>circuit</title>
        <meta charset="utf-8">
        <script src="texture.js"></script>
    </haed>
    <body>
        <div>
            <button onclick="changevl(-1)">↑</button>
            レイヤ
            <button onclick="changevl(1)">下</button>
            <span id="slayer">0</span>
        </div>
        <canvas id="imgOut"></canvas>
    </body>
</html>
<script>
    size = [20,20,5]


    blockdef = { // definition of blocks - id: [[high],[low],sw]
        0: [[],[],0], // 空ブロック
        1: [[[0,0,0]],[[0,0,0]],0], // 信号源ブロック
        2: [[[-1,0,0]],[],0], // 東向き配線ブロック
        3: [[[0,-1,0]],[],0], // 南向き配線ブロック
        4: [[[1,0,0]],[],0], // 西向き配線ブロック
        5: [[[0,1,0]],[],0], // 北向き配線ブロック
        6: [[[0,0,-1]],[],0], // 下向き配線ブロック
        7: [[[0,0,1]],[],0], // 上向き配線ブロック
        8: [[[-2,0,0]],[],0], // 東向きジャンプブロック
        9: [[[0,-2,0]],[],0], // 南向きジャンプブロック
        10: [[[2,0,0]],[],0], // 西向きジャンプブロック
        11: [[[0,2,0]],[],0], // 北向きジャンプブロック
        12: [[],[[-1,0,0]],0], // 東向きNOTブロック
        13: [[],[[0,-1,0]],0], // 南向きNOTブロック
        14: [[],[[1,0,0]],0], // 西向きNOTブロック
        15: [[],[[0,1,0]],0], // 北向きNOTブロック
        16: [[[1,0,0],[0,-1,0]],[],0], // 北東ORブロック
        17: [[[1,0,0],[0,1,0]],[],0], // 南東ORブロック
        18: [[[-1,0,0],[0,-1,0]],[],0], // 北西ORブロック
        19: [[[-1,0,0],[0,1,0]],[],0], // 南西ORブロック
        20: [[[-1,0,0],[1,0,0]],[],0], // 東西ORブロック
        21: [[[0,-1,0],[0,1,0]],[],0], // 南北ORブロック
        22: [[],[],1], // スイッチブロック
        23: [[[-1,0,0],[0,-1,0],[1,0,0],[0,1,0]],[],0], // 赤色照明ブロック
    }
    blockname = {
        0: "空ブロック",
        1: "信号源ブロック",
        2: "東向き配線ブロック",
        3: "南向き配線ブロック",
        4: "西向き配線ブロック",
        5: "北向き配線ブロック",
        6: "下向き配線ブロック",
        7: "上向き配線ブロック",
        8: "東向きジャンプブロック",
        9: "南向きジャンプブロック",
        10: "西向きジャンプブロック",
        11: "北向きジャンプブロック",
        12: "東向きNOTブロック",
        13: "南向きNOTブロック",
        14: "西向きNOTブロック",
        15: "北向きNOTブロック",
        16: "北東ORブロック",
        17: "南東ORブロック",
        18: "北西ORブロック",
        19: "南西ORブロック",
        20: "東西ORブロック",
        21: "南北ORブロック",
        22: "スイッチブロック",
        23: "赤色照明ブロック",
    }


    delay = 50
    autoplay = true
        if (autoplay) {
            setTimeout(next,delay);
        }
    function first() {
        barr = new Uint8ClampedArray(size[0]*size[1]*size[2]).fill(0);
        swarr = new Uint8ClampedArray(size[0]*size[1]*size[2]).fill(0);
        mkimg(barr);
        resizeImg();
    }

    function swchange(x,y) {
        let idx = vl*size[0]*size[1]+y*size[0]+x;
        if (blarr[idx]==22) {
            if (swarr[idx]==1) {
                swarr[idx] = 0;
            }
            else {
                swarr[idx] = 1;
            }
        }
    }

    function next() {
        let narr = new Uint8ClampedArray(size[0]*size[1]*size[2]).fill(0);
        for (let iz = 0; iz < size[2]; iz++) {
            for (let iy = 0; iy < size[1]; iy++) {
                for (let ix = 0; ix < size[0]; ix++) {
                    let ii = iz*size[0]*size[1]+iy*size[0]+ix;
                    blt = blarr[ii]
                    let blkprc = blockdef[blarr[ii]];
                    if (blarr[ii]==31) {
                        console.log(31)
                    }
                    if (blkprc[2]==1) {
                        narr[ii] = 1;
                        continue;
                    }
                    else if (blkprc[2]==2) {
                        if (swarr[ii]==1) {
                            narr[ii] = 1;
                            continue;
                        }
                    }
                    for (i=0;i<blkprc[0].length;i++) {
                        let bi = (iz+blkprc[0][i][2])*size[0]*size[1]+(iy+blkprc[0][i][1])*size[0]+ix+blkprc[0][i][0];
                        if (barr[bi]==1) {
                            narr[ii] = 1;
                        }
                    }
                    for (i=0;i<blkprc[1].length;i++) {
                        let bi = (iz+blkprc[1][i][2])*size[0]*size[1]+(iy+blkprc[1][i][1])*size[0]+ix+blkprc[1][i][0];
                        if (barr[bi]==0) {
                            narr[ii] = 1;
                        }
                    }
                }
            }
        }
        barr = narr;
        mkimg(barr);
        if (autoplay) {
            setTimeout(next,delay);
        }
    }




function down(e) {
    let x = Math.floor(e.offsetX/8);
    let y = Math.floor(e.offsetY/8);
    swchange(x,y)
}
imgelm = document.getElementById("imgOut")
imgelm.addEventListener('mousedown', down);
imgelm.addEventListener('touchstart', down);


let vl = 0 // view layer
function changevl(z) {
    vl += z;
    if (vl<0) {
        vl = 0;
    }
    else if (vl>=size[2]) {
        vl = size[2]-1;
    }
    document.getElementById("slayer").innerHTML = vl
}

    function mkimg(barr) {
        let iarr = new Uint8ClampedArray(size[0]*size[1]*4*64).fill(255);
        for (let iy = 0; iy < size[1]; iy++) {
            for (let ix = 0; ix < size[0]; ix++) {
                let ii = vl*size[0]*size[1]+iy*size[0]+ix;
                let btx = texture[1-barr[ii]][blarr[ii]]
                for (let by = 0; by < 8; by++) {
                    for (let bx = 0; bx < 8; bx++) {
                        let bi = ((iy*8+by)*8*size[0]+ix*8+bx)*4

                        iarr[bi+0] = colordef[btx[by][bx]][0];
                        iarr[bi+1] = colordef[btx[by][bx]][1];
                        iarr[bi+2] = colordef[btx[by][bx]][2];
                    }
                }
            }
        }
        let co = document.getElementById("imgOut");
        co.height=size[1]*8;co.width=size[0]*8;co.getContext('2d').putImageData(new ImageData(iarr,size[0]*8,size[1]*8),0,0);
    }

window.onload = first
</script>
<script>
    
    function read(darr) {
        if (darr[0x00]!=0x6E||darr[0x01]!=0x63||darr[0x02]!=0x67) { // check
            console.warn("Is it a ncg file?");
        }
        let tmpprojname = darr.slice(0x04,0x19);
        let projnamearr = [];
        for (let ltp=0;ltp<tmpprojname.length;ltp++) {
            if (tmpprojname[ltp]==0x00) {break;}
            projnamearr.push(tmpprojname[ltp]);
        }
        let projname = (new TextDecoder("utf-8")).decode(new Uint8Array(projnamearr));
        let wsize = [darr[0x1A]+darr[0x1B]*0x100,darr[0x1C]+darr[0x1D]*0x100,darr[0x1E]+darr[0x1F]*0x100,];
        console.log(projname,wsize);
        let tmpblarr = darr.slice(0x20);
        blarr = new Uint8ClampedArray(tmpblarr.length);
        for (let ib=0;ib<tmpblarr.length;ib++) {
            blarr[ib] = tmpblarr[ib]-65
        }
        
        barr = new Uint8ClampedArray(size[0]*size[1]*size[2]).fill(0);
        swarr = new Uint8ClampedArray(size[0]*size[1]*size[2]).fill(0);
    }

    function localfile() {
        ifelm = document.createElement("input");
        ifelm.type = "file";
        ifelm.onchange = function (input) {
            let reader = new FileReader();
            reader.onload = function () {
                let result = new Uint8Array(reader.result);
                read(result);
            }
            reader.readAsArrayBuffer(input.target.files[0]);
        };
        ifelm.click();
    }

    let params = location.href.split("?")[1]
    if (params!=null) {
        let spram = new URLSearchParams(params)
        ltype = spram.get("type");
        llink = spram.get("link");
        if (ltype!=null&&llink!=null) {
            console.log(ltype,llink)
            switch (ltype) {
                case "url":
                    let req = new XMLHttpRequest();
                    req.open("GET",llink)
                    req.responseType = "arraybuffer";
                    req.onload = function(e) {
                        let resp = req.response
                        console.log(resp)
                        read(new Uint8Array(resp))
                    }
                    req.send()
                    break;
                default:
                    console.error("link type not found")
                    break;
            }
        }
    }
    function dl() {
        let projname = "testproject" // project name
        let fnm = projname+".ncg";
        let darr = new Uint8ClampedArray(barr.length+0x20).fill(00); // fill the data with 0
        darr[0]=0x6E;darr[1]=0x63;darr[2]=0x67; // write the file name
        let wsf = [Math.floor(size[0]),Math.floor(size[1]),Math.floor(size[2])];
        let wsize = [wsf[0]%0x100,Math.floor((wsf[0]-wsf[0]%0x100)/0x100),wsf[1]%0x100,Math.floor((wsf[1]-wsf[1]%0x100)/0x100),wsf[2]%0x100,Math.floor((wsf[2]-wsf[2]%0x100)/0x100)];
        let ecdn = (new TextEncoder("utf-8")).encode(projname); // encode the project name with utf-8
        for (let inm=0;inm<ecdn.length;inm++) { // write the project name
            darr[inm+0x04] = ecdn[inm]; // the name-area starts at 0x04
        }
        for (let is=0;is<wsize.length;is++) { // write the project size
             darr[is+0x1A] = wsize[is]; // the size-area starts at 0x1A
        }
        for (let i=0;i<barr.length;i++) { // write main data
            darr[i+0x20] = blarr[i]+65; // the data-area starts at 0x20
        }
        let ftype = "application/octet-stream";
        let blob = new Blob([darr], {type: ftype});
        const file = new File([blob], fnm, {type: ftype}); // make the file
        let aelm = document.createElement("a");aelm.download = fnm;
        aelm.href = window.URL.createObjectURL(file);aelm.click(); // download the file
        dldata = darr;
    }

</script>
<script>
// resize window
function resizeImg() {
    canvas = document.getElementById("imgOut")
    dw = canvas.width;
    dh = canvas.height;
    let bottom_area = 0;
    let rw = 0;let rh = 0;
    let ww = window.innerWidth;
    let wh = window.innerHeight-bottom_area;
    let csc = 1
    hcsc = ww/dw
    wcsc = wh/dh
    // console.log(hcsc,wcsc)
    if (hcsc>wcsc) {
        csc = wcsc
        rw = (ww - dw*csc)/2
    }
    else {
        csc = hcsc
        rh = (wh - dh*csc)/2
    }
    canvas.style.marginTop = (rh).toString()+"px";
    canvas.style.marginBottom = (rh).toString()+"px";
    canvas.style.marginLeft = (rw).toString()+"px";
    canvas.style.marginRight = (rw).toString()+"px";
    canvas.style.transform = "scale("+csc.toString()+","+csc.toString()+")";
};
resizeImg();
window.onresize = resizeImg;
</script>
<style>
    body {
        background-color:bisque;
    }
    #imgOut {
        transform-origin: left top;
        position: absolute;
        top: 0;
        left: 0;
        image-rendering: pixelated;
    }
</style>